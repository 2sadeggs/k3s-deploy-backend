# K3s Deploy Backend

ä¸€ä¸ªç”¨äºè‡ªåŠ¨åŒ–éƒ¨ç½²K3sé›†ç¾¤å¹¶å®‰è£…inSuiteåº”ç”¨çš„åç«¯æœåŠ¡ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **è‡ªåŠ¨åŒ–K3sé›†ç¾¤éƒ¨ç½²**ï¼šæ”¯æŒå•èŠ‚ç‚¹ã€åŒèŠ‚ç‚¹ã€ä¸‰èŠ‚ç‚¹éƒ¨ç½²æ¨¡å¼
- ğŸ” **å¤šç§SSHè®¤è¯**ï¼šæ”¯æŒå¯†ç å’Œå¯†é’¥è®¤è¯æ–¹å¼
- ğŸ“Š **å®æ—¶éƒ¨ç½²ç›‘æ§**ï¼šæä¾›è¯¦ç»†çš„éƒ¨ç½²è¿›åº¦å’Œæ—¥å¿—
- ğŸ·ï¸ **æ™ºèƒ½èŠ‚ç‚¹æ ‡ç­¾**ï¼šè‡ªåŠ¨ä¸ºèŠ‚ç‚¹åˆ†é…è§’è‰²æ ‡ç­¾
- ğŸ“¦ **åº”ç”¨è‡ªåŠ¨éƒ¨ç½²**ï¼šè‡ªåŠ¨éƒ¨ç½²inSuiteåº”ç”¨ç»„ä»¶
- ğŸ” **éƒ¨ç½²éªŒè¯**ï¼šè‡ªåŠ¨éªŒè¯é›†ç¾¤å’Œåº”ç”¨éƒ¨ç½²çŠ¶æ€

## ç³»ç»Ÿæ¶æ„

```
â”œâ”€â”€ cmd/server/           # åº”ç”¨å…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ handler/          # HTTPå¤„ç†å±‚
â”‚   â”œâ”€â”€ service/          # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ model/           # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ pkg/             # æ ¸å¿ƒç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ssh/         # SSHå®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ k3s/         # K3sç®¡ç†
â”‚   â”‚   â””â”€â”€ logger/      # æ—¥å¿—ç»„ä»¶
â”‚   â””â”€â”€ router/          # è·¯ç”±é…ç½®
â”œâ”€â”€ pkg/utils/           # å·¥å…·å‡½æ•°
â””â”€â”€ scripts/             # å®‰è£…è„šæœ¬
```

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Go 1.19+
- ç›®æ ‡èŠ‚ç‚¹éœ€è¦rootæƒé™
- ç›®æ ‡èŠ‚ç‚¹éœ€è¦æ”¯æŒcurlå’Œsystemd

### å®‰è£…ä¾èµ–

```bash
go mod tidy
```

### å¯åŠ¨æœåŠ¡

```bash
go run cmd/server/main.go
```

æœåŠ¡å°†åœ¨ `http://localhost:8080` å¯åŠ¨

## API æ¥å£

### SSHè¿æ¥æµ‹è¯•

**å•èŠ‚ç‚¹æµ‹è¯•**
```bash
POST /api/ssh/test
{
  "ip": "192.168.1.100",
  "port": 22,
  "username": "root",
  "authType": "password",
  "password": "your_password"
}
```

**æ‰¹é‡æµ‹è¯•**
```bash
POST /api/ssh/test-batch
{
  "nodes": [
    {
      "id": 1,
      "name": "k3s-master",
      "ip": "192.168.1.100",
      "port": 22,
      "username": "root",
      "authType": "password",
      "password": "your_password"
    }
  ]
}
```

### K3sé›†ç¾¤éƒ¨ç½²

```bash
POST /api/k3s/deploy
{
  "deployMode": "single",
  "step": "validate",
  "nodes": [...],
  "roleAssignment": {
    "app": "k3s-master",
    "middleware": "k3s-master",
    "database": "k3s-master"
  },
  "labels": {...}
}
```

## éƒ¨ç½²æ­¥éª¤

1. **validate** - éªŒè¯èŠ‚ç‚¹è¿æ¥å’Œç³»ç»Ÿè¦æ±‚
2. **install-master** - å®‰è£…K3s MasterèŠ‚ç‚¹
3. **configure-agent** - é…ç½®K3s AgentèŠ‚ç‚¹
4. **apply-labels** - åº”ç”¨èŠ‚ç‚¹æ ‡ç­¾
5. **deploy-insuite** - éƒ¨ç½²inSuiteåº”ç”¨
6. **verify** - éªŒè¯éƒ¨ç½²çŠ¶æ€

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
# æœåŠ¡å™¨é…ç½®
SERVER_PORT=8080
READ_TIMEOUT=30
WRITE_TIMEOUT=30

# K3sé…ç½®
K3S_VERSION=latest
DEFAULT_NAMESPACE=insuite

# SSHé…ç½®
SSH_CONNECT_TIMEOUT=30
SSH_COMMAND_TIMEOUT=300
SSH_MAX_RETRIES=3

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_FORMAT=text
```

### ç»„ä»¶é•œåƒ

- **æ•°æ®åº“**: postgres:13
- **ä¸­é—´ä»¶**: redis:6
- **åº”ç”¨**: nginx:latest

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **SSHè¿æ¥**: ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨å¯†é’¥è®¤è¯
2. **ä¸»æœºå¯†é’¥éªŒè¯**: å½“å‰ä¸ºå¼€å‘æ¨¡å¼ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦éªŒè¯ä¸»æœºå¯†é’¥
3. **ç½‘ç»œå®‰å…¨**: ç¡®ä¿K3s APIç«¯å£(6443)çš„ç½‘ç»œå®‰å…¨
4. **æƒé™ç®¡ç†**: éƒ¨ç½²ç”¨æˆ·éœ€è¦å…·æœ‰rootæƒé™

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **SSHè¿æ¥å¤±è´¥**
   - æ£€æŸ¥IPåœ°å€å’Œç«¯å£
   - éªŒè¯è®¤è¯ä¿¡æ¯
   - ç¡®è®¤ç›®æ ‡ä¸»æœºSSHæœåŠ¡è¿è¡ŒçŠ¶æ€

2. **K3så®‰è£…å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯ç³»ç»Ÿè¦æ±‚ï¼ˆå†…å­˜ã€ç£ç›˜ï¼‰
   - æŸ¥çœ‹å®‰è£…æ—¥å¿—

3. **åº”ç”¨éƒ¨ç½²å¤±è´¥**
   - æ£€æŸ¥èŠ‚ç‚¹æ ‡ç­¾é…ç½®
   - éªŒè¯é•œåƒæ‹‰å–çŠ¶æ€
   - æŸ¥çœ‹Podæ—¥å¿—

### æ—¥å¿—æŸ¥çœ‹

æœåŠ¡æ—¥å¿—åŒ…å«è¯¦ç»†çš„æ“ä½œä¿¡æ¯ï¼š
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f /var/log/k3s-deploy.log

# æŸ¥çœ‹SSHè¿æ¥æ—¥å¿—
grep "ssh_connection" /var/log/k3s-deploy.log

# æŸ¥çœ‹éƒ¨ç½²è¿›åº¦
grep "deployment" /var/log/k3s-deploy.log
```

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„éƒ¨ç½²æ­¥éª¤

1. åœ¨ `internal/service/deploy_service.go` ä¸­æ·»åŠ æ­¥éª¤å¤„ç†å‡½æ•°
2. åœ¨ `stepHandlers` æ˜ å°„ä¸­æ³¨å†Œæ–°æ­¥éª¤
3. æ›´æ–°å‰ç«¯çš„æ­¥éª¤é…ç½®

### è‡ªå®šä¹‰ç»„ä»¶é•œåƒ

ä¿®æ”¹ `internal/pkg/k3s/manager.go` ä¸­çš„éƒ¨ç½²é…ç½®ï¼Œæˆ–é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é»˜è®¤é•œåƒã€‚

## è®¸å¯è¯

MIT License 